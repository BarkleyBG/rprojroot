---
title: "Finding files reliably"
author: "Kirill MÃ¼ller"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Finding files reliably}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The `rprojroot` package solves a seemingly trivial but annoying problem
that occurs sooner or later
in any largish project:
How to find files in subdirectories?
Relative file paths are almost always preferable to absolute paths,
but relative to what should they be?
Unfortunately, we cannot always be sure about the value of the working directory:
For instance, in RStudio,
sometimes it's the project root (when running R scripts),
sometimes a subdirectory (when building vignettes),
sometimes again the project root (when executing chunks of a vignette):

```{r}
basename(getwd())
```

If we could only get hold of our...


## Project root

The *root* of a project is defined as a directory that contains a regular file
whose name matches a given pattern and whose contents optionally match
another pattern.
Thus, the following method reliably finds our project root:

- Start the search in any subdirectory of our project
- Proceed up the directory hierarchy until finding a file that matches
the criteria

The Git version control system (and probably many other tools) use a similar
approach: A Git command can be executed from within any subdirectory of a
repository.


## A simple example

The `find_root` function is the central function of this package.
It returns the path to the first directory that matches the filtering criteria,
or throws an error if there is no such directory.

```{r}
library(rprojroot)

# List all files below the root
dir(find_root(glob2rx("DESCRIPTION"), recursive = TRUE)

# Find a file relative to the root
file.exists(find_root_file("R", "root.R", filename = glob2rx("DESCRIPTION")))
```

Note that the following code produces identical results when building the
vignette *and* when sourcing the chunk, provided that the project root is the current working directory or a parent thereof.


## Practical use

To avoid specifying the search criteria for the project root every time,
shortcut functions can be created.
Shortcuts are predefined for RStudio projects and packages:

```{r}
# Show definition of shortcut function
print(find_package_root_file)

# Print first lines of the source for this document
head(readLines(find_package_root_file("vignettes", "rprojroot.Rmd")))
```

To save typing effort, define a shorter alias:

```{r}
P <- find_package_root_file

# Use a shorter alias
file.exists(P("vignettes", "rprojroot.Rmd"))
```

You might also want to define your project root differently
(this fails here -- we look for a file named `LICENSE` which is absent):

```{r}
# Define a function that computes file paths below a directory with a file named LICENSE
R <- make_find_root_file(glob2rx("LICENSE"))
R

# Our package does not have such a file, trying to find the root results in an error
class(try(dir.exists(R("man"))))
```


## Fixed root

We can also create a function
that computes a path relative to the root *at creation time*.

```{r}
# Define a function that computes file paths below the current root
F <- make_fix_root_file(glob2rx("DESCRIPTION"))

# Show contents of the NAMESPACE file in our project
readLines(F("NAMESPACE"))
```

This even works if we later change the working directory to somewhere outside
the project:

```{r}
# Print the size of the namespace file, working directory outside the project
local({
  oldwd <- setwd("../..")
  on.exit(setwd(oldwd), add = TRUE)
  file.size(F("NAMESPACE"))
})
```


## Summary

The `rprojroot` package allows easy access to files below a project root
which is supposed to be the only directory in the whole hierarchy that contains
a specific file.
This is a robust solution for finding project files in largish projects
with a subdirectory hierarchy if the current working directory cannot be assumed
fixed.
(However, at least initially, the current working directory must be
somewhere below the project root.)


## Acknowledgement

This package was inspired by the gist
["Stop the working directory insanity"](https://gist.github.com/jennybc/362f52446fe1ebc4c49f)
by Jennifer Bryan, and by the way Git knows where its files are.
